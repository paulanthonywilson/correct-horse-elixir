#!/usr/bin/env bash 

set -e

SCRIPT_PATH=`dirname $0`
BASE_PATH=`realpath "$SCRIPT_PATH/.."`
KEY_PATH="$BASE_PATH/deploy/secrets"

cd $BASE_PATH

mix compile

mkdir -p $KEY_PATH
echo '*' > "$KEY_PATH/.gitignore"

secret_list=`cat "$BASE_PATH/deploy/release_vars"`

for secret in  $secret_list
do
    file="$BASE_PATH/deploy/secrets/$secret"
    if [ -f "$file" ]; then
        echo "👍 $file"
    else
        echo "👎 $file. Correcting."
        key=`mix phx.gen.secret | tr -d '\n' `
        echo $key > $file
    fi
done