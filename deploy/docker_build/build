#!/usr/bin/env bash

set -e

. ~/.asdf/asdf.sh


APP_NAME=correcthorse_main
APP_VSN=`head VERSION | tr -d "\n"`
SECRET_KEY_DIR=/opt/src/deploy/keys

echo $APP_NAME
echo $APP_VSN


rm -rf /opt/build
mkdir -p /opt/build
mkdir -p /opt/src/deploy/release/
echo '*' > /opt/src/deploy/release/.gitignore
cp -r .git /opt/build
cd /opt/build
git checkout -f 


# Install updated versions of hex/rebar
mix local.rebar --force
mix local.hex --if-missing --force



## Secret keys 

mkdir -p $SECRET_KEY_DIR
echo '*' > $SECRET_KEY_DIR/.gitignore

secret_key(){
    file="$SECRET_KEY_DIR/$1"
    if [ -f "$file" ]; then
        key=`head "$file" | tr -d '\n'`
    else
        MIX_ENV=dev mix deps.get
        MIX_ENV=dev mix compile
        key=`mix phx.gen.secret | tr -d '\n' `
        echo $key > $file
    fi
    echo $key
}


export SECRET_KEY_BASE=$(secret_key secret_key_base)
export LIVE_VIEW_SALT=$(secret_key live_view_salt)
export ADMIN_USER=$(secret_key admin_user)
export ADMIN_PASSWORD=$(secret_key admin_password)

export MIX_ENV=prod

mix deps.get --only prod
mix compile

# do the asset stuff
npm install --prefix ./apps/correcthorse_web/assets
npm run deploy --prefix ./apps/correcthorse_web/assets

mix phx.digest


# Build the release
mix release $APP_NAME

# tar the release
cd "_build/prod/rel/$APP_NAME/"
tar zcvf /opt/src/deploy/release/$APP_NAME.tar.gz  .



exit 0
